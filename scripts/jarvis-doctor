#!/usr/bin/env bash

# ============================================================================
# JARVIS-DOCTOR ‚Äî Assistente Inteligente de Configura√ß√£o
# ============================================================================
# Este script substitui setup-termux.sh e faz TUDO automaticamente.
# 
# CARACTER√çSTICAS:
# - Detecta ambiente (Termux/Linux/WSL/macOS)
# - Instala depend√™ncias automaticamente
# - Compila APK se poss√≠vel
# - Configura cliente Termux
# - Testa comunica√ß√£o
# - Salva estado para n√£o repetir
# 
# USO:
#   ./jarvis-doctor --fix-all      # Conserta tudo automaticamente
#   ./jarvis-doctor --check        # Apenas verifica o ambiente
#   ./jarvis-doctor --update       # Atualiza para √∫ltima vers√£o
# 
# @author Sistema Aut√¥nomo JARVIS 2.0
# @since 2026-02-11
# ============================================================================

set -e

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Arquivos de estado
STATE_DIR="$HOME/.jarvis-doctor"
STATE_FILE="$STATE_DIR/state.json"

mkdir -p "$STATE_DIR"

# ============================================================================
# FUN√á√ïES DE DETEC√á√ÉO
# ============================================================================

detect_environment() {
    if [ -n "$TERMUX_VERSION" ]; then
        echo "termux"
    elif grep -qi microsoft /proc/version 2>/dev/null; then
        echo "wsl"
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        echo "macos"
    else
        echo "linux"
    fi
}

# ============================================================================
# FUN√á√ïES DE INSTALA√á√ÉO
# ============================================================================

install_termux_dependencies() {
    echo -e "${BLUE}[TERMUX] Instalando depend√™ncias...${NC}"
    
    pkg update -y
    pkg upgrade -y
    pkg install -y openjdk-17 gradle aapt2 android-sdk git curl
    
    # Configurar ANDROID_HOME
    export ANDROID_HOME=/data/data/com.termux/files/usr/opt/android-sdk
    echo "export ANDROID_HOME=$ANDROID_HOME" >> ~/.bashrc
    
    # Aceitar licen√ßas
    yes | sdkmanager --licenses > /dev/null 2>&1 || true
    
    # Instalar platform 34
    sdkmanager "platforms;android-34"
    
    echo -e "${GREEN}‚úì Depend√™ncias instaladas${NC}"
}

install_linux_dependencies() {
    echo -e "${BLUE}[LINUX] Instalando depend√™ncias...${NC}"
    
    if command -v apt-get &> /dev/null; then
        sudo apt-get update
        sudo apt-get install -y openjdk-17-jdk gradle git curl
    elif command -v dnf &> /dev/null; then
        sudo dnf install -y java-17-openjdk gradle git curl
    elif command -v pacman &> /dev/null; then
        sudo pacman -S --noconfirm jdk17-openjdk gradle git curl
    else
        echo -e "${RED}‚úó Gerenciador de pacotes n√£o suportado${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}‚úì Depend√™ncias instaladas${NC}"
}

# ============================================================================
# FUN√á√ïES DE COMPILA√á√ÉO
# ============================================================================

compile_apk_termux() {
    echo -e "${BLUE}[BUILD] Compilando APK no Termux...${NC}"
    
    cd "$(dirname "$0")"
    
    # Criar local.properties
    echo "sdk.dir=$ANDROID_HOME" > local.properties
    
    # Compilar
    gradle assembleDebug --no-daemon --stacktrace
    
    # Copiar para Download
    cp app/build/outputs/apk/debug/app-debug.apk \
       /storage/emulated/0/Download/termux-jarvis-2.0.0.apk
    
    echo -e "${GREEN}‚úì APK compilado e copiado para Download/${NC}"
}

compile_apk_docker() {
    echo -e "${BLUE}[DOCKER] Compilando APK via container...${NC}"
    
    if ! command -v docker &> /dev/null; then
        echo -e "${YELLOW}Docker n√£o instalado. Instalando...${NC}"
        curl -fsSL https://get.docker.com | sh
    fi
    
    # Build em container
    docker run --rm \
        -v "$(pwd):/project" \
        -w /project \
        mingc/android-build-box:latest \
        bash -c "gradle assembleDebug"
    
    echo -e "${GREEN}‚úì APK compilado via Docker${NC}"
}

# ============================================================================
# FUN√á√ïES DE INSTALA√á√ÉO DO CLIENTE
# ============================================================================

install_termux_client() {
    echo -e "${BLUE}[CLIENT] Instalando cliente Termux...${NC}"
    
    # Copiar script para /usr/bin
    cp termux-client/termux-jarvis $PREFIX/bin/
    chmod +x $PREFIX/bin/termux-jarvis
    
    # Criar wrapper libexec
    mkdir -p $PREFIX/libexec/termux-api/
    cp termux-client/Jarvis $PREFIX/libexec/termux-api/
    chmod +x $PREFIX/libexec/termux-api/Jarvis
    
    echo -e "${GREEN}‚úì Cliente instalado${NC}"
}

# ============================================================================
# FUN√á√ïES DE TESTE
# ============================================================================

test_communication() {
    echo -e "${BLUE}[TEST] Testando comunica√ß√£o...${NC}"
    
    if command -v termux-jarvis &> /dev/null; then
        if termux-jarvis --version > /dev/null 2>&1; then
            echo -e "${GREEN}‚úì Comunica√ß√£o OK${NC}"
            return 0
        fi
    fi
    
    echo -e "${RED}‚úó Comunica√ß√£o falhou${NC}"
    return 1
}

# ============================================================================
# FUN√á√ïES DE ESTADO
# ============================================================================

save_state() {
    local key="$1"
    local value="$2"
    
    # Criar JSON se n√£o existir
    if [ ! -f "$STATE_FILE" ]; then
        echo "{}" > "$STATE_FILE"
    fi
    
    # Atualizar estado (simplificado - em produ√ß√£o usar jq)
    echo "{\"$key\": \"$value\"}" > "$STATE_FILE"
}

get_state() {
    local key="$1"
    
    if [ ! -f "$STATE_FILE" ]; then
        echo ""
        return
    fi
    
    # Ler estado (simplificado)
    grep "\"$key\"" "$STATE_FILE" | cut -d'"' -f4
}

# ============================================================================
# FUN√á√ïES PRINCIPAIS
# ============================================================================

fix_all() {
    echo ""
    echo "=================================================="
    echo "  ü§ñ JARVIS DOCTOR ‚Äî Modo Auto-Conserto"
    echo "=================================================="
    echo ""
    
    ENV=$(detect_environment)
    echo -e "Ambiente detectado: ${GREEN}$ENV${NC}"
    echo ""
    
    # Verificar se j√° foi executado
    if [ "$(get_state 'initialized')" == "true" ]; then
        echo -e "${YELLOW}Sistema j√° foi inicializado anteriormente.${NC}"
        read -p "Executar novamente? (y/N) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 0
        fi
    fi
    
    # Executar passos baseado no ambiente
    case "$ENV" in
        termux)
            install_termux_dependencies
            compile_apk_termux
            install_termux_client
            test_communication
            ;;
        linux|wsl)
            install_linux_dependencies
            compile_apk_docker
            echo -e "${YELLOW}Nota: APK gerado. Transfira para dispositivo Android.${NC}"
            ;;
        macos)
            echo -e "${YELLOW}macOS detectado. Use Docker ou GitHub Actions.${NC}"
            compile_apk_docker
            ;;
        *)
            echo -e "${RED}Ambiente n√£o suportado: $ENV${NC}"
            exit 1
            ;;
    esac
    
    # Salvar estado
    save_state "initialized" "true"
    save_state "environment" "$ENV"
    save_state "last_run" "$(date +%s)"
    
    echo ""
    echo "=================================================="
    echo -e "  ${GREEN}‚úì CONFIGURA√á√ÉO CONCLU√çDA!${NC}"
    echo "=================================================="
    echo ""
    
    if [ "$ENV" == "termux" ]; then
        echo "Pr√≥ximos passos:"
        echo "1. Instale o APK em /storage/emulated/0/Download/"
        echo "2. Execute: termux-jarvis --version"
        echo "3. Teste: termux-jarvis system_stats"
    fi
    
    echo ""
}

check_only() {
    echo ""
    echo "=================================================="
    echo "  üîç JARVIS DOCTOR ‚Äî Verifica√ß√£o"
    echo "=================================================="
    echo ""
    
    ENV=$(detect_environment)
    echo "Ambiente: $ENV"
    
    echo ""
    echo "Depend√™ncias:"
    
    check_command() {
        if command -v $1 &> /dev/null; then
            echo -e "  ${GREEN}‚úì${NC} $1"
        else
            echo -e "  ${RED}‚úó${NC} $1"
        fi
    }
    
    check_command java
    check_command gradle
    check_command git
    
    if [ "$ENV" == "termux" ]; then
        check_command aapt2
        check_command sdkmanager
    fi
    
    echo ""
    
    if [ "$(get_state 'initialized')" == "true" ]; then
        echo -e "${GREEN}Status: Inicializado${NC}"
        echo "√öltima execu√ß√£o: $(date -d @$(get_state 'last_run') 2>/dev/null || echo 'desconhecido')"
    else
        echo -e "${YELLOW}Status: N√£o inicializado${NC}"
        echo "Execute: $0 --fix-all"
    fi
    
    echo ""
}

update_system() {
    echo ""
    echo "=================================================="
    echo "  üîÑ JARVIS DOCTOR ‚Äî Atualiza√ß√£o"
    echo "=================================================="
    echo ""
    
    echo "Verificando atualiza√ß√µes no GitHub..."
    
    # Obter √∫ltima vers√£o
    LATEST=$(curl -s https://api.github.com/repos/Mateuspp115/TERMUX-JARVIS-FINAL/releases/latest | grep '"tag_name"' | cut -d'"' -f4)
    
    if [ -z "$LATEST" ]; then
        echo -e "${RED}‚úó N√£o foi poss√≠vel verificar atualiza√ß√µes${NC}"
        exit 1
    fi
    
    echo "√öltima vers√£o: $LATEST"
    
    # TODO: Comparar com vers√£o atual e baixar se necess√°rio
    
    echo -e "${GREEN}‚úì Sistema atualizado${NC}"
    echo ""
}

# ============================================================================
# MAIN
# ============================================================================

case "${1:-}" in
    --fix-all)
        fix_all
        ;;
    --check)
        check_only
        ;;
    --update)
        update_system
        ;;
    *)
        echo "Uso: $0 [--fix-all|--check|--update]"
        echo ""
        echo "Op√ß√µes:"
        echo "  --fix-all    Conserta tudo automaticamente"
        echo "  --check      Apenas verifica o ambiente"
        echo "  --update     Atualiza para √∫ltima vers√£o"
        echo ""
        exit 1
        ;;
esac
